{"filename":"mhw_plot_sst_anomalies_distribution_map_example.yml","file_hash":"53d797c1815607c99ed8ace11b72d5a944517c2f481cbf3167f8c60328160178","doc_summary":"OpenAPI Specification: mhw_plot_sst_anomalies_distribution_map_example.yml","text_chunks":[{"chunk_id":0,"source_page":1,"content_type":"metadata","text":"dataset: marineheatwave\ncollection: mhw\ndoc_type: code_snippet\ntitle: \"Example: Plotting SST anomalies distribution map and timeseries by using ODB MHW API\"\nlang: en\nissuer: \"ODB Project (internal)\"\ncanonical_url: \"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb\"\nlicense: \"MIT\"\nretrieved_at: \"2025-08-26\"\ndoc_id: \"94eff5435a8e3c4ab192526d1d7d3f81e04f202f\"\ntags: [程式, MHW, API, timeseries, Python, map, \"code example\", \"Marine Heatwaves\", \"SST anomalies\", ENSO, \"時間序列\", \"地圖\"]\nrelated_to:\n  - doc_id: [\"c4aca131c497500a668336dacb65f08ade88077a\", \"ddba171bda668c60390ee6fab602b037efb73539\", \"d971ef8bbc81997eae74ee0e555588a6526b0ea1\", \"4b60022c85f6a8bc3253552ba03f695e996519c5\"]\n  - collection: \"mhw\"\ndepends_on:\n  - manuals/odb_mhw_openapi.yml\nsource_file: \"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb\"\nsource_type: code\npurpose: \"以程式範例說明如何使用ODB MHW API調用海表溫距平值的時間和空間資料並畫地圖與時間序列圖\"\nfaq: [\"如何在地圖上呈現海溫(分佈地圖)\", \"Provide python examples\", \"How to get timeseries of marine data\", \"畫海溫趨勢變化\"]\ncontent: |\n  # Usage Note\n  '''\n    本文件提供 ODB MHW API 的 python 程式範例，回答以下問題時應優先引用：如何撰寫程式範例、如何做圖或以程式畫出海溫變化趨勢等(列於faq)。\n    在提供的程式中，除了畫出海表溫距平值的空間分佈地圖(以Niño 3.4區域為例)以外，還畫出Niño Index (ONI)指數的時序圖(1982-present)，\n    並和NOAA提供的ONI指數時間序列(1950-present)比較(相關知識可參考doc_id: c4aca131c497500a668336dacb65f08ade88077a)。\n    程式雖然以海表溫距平值(sst_anomaly)為例，但以相同叫用ODB MHW API的方式，也可以畫出海溫（海水表面溫度）(sst)的空間分佈或時間序列。\n    This document provides Python examples for the ODB MHW API and should be referenced first when answering questions about code writing or plotting (listed in faq).\n    The provided code generates:\n      * A spatial map of sea surface temperature anomalies (using the Niño 3.4 region as an example)\n      * A time series of the Niño Index (ONI) from 1982 to present, compared with NOAA’s ONI data (1950–present)\n        (refer to doc_id: c4aca131c497500a668336dacb65f08ade88077a for related info)\n    This example use \"sst_anomaly\" (SST anomalies) as example, and in the same way we can plot map or timeseries for \"sst\" (Sea Surface Temperature, SST) by fetching ODB MHW API as well.\n    請注意ODB MHW API輸出的時間參數是'date', 若需要對時間畫圖(時序圖)，x-axis須選擇'date'\n          輸出的經緯度座標參數則是'lon', 'lat'，若需要畫出地圖，須採用'lon', 'lat'對應的資料值。\n  '''\n\n  # Code block  \n  ```python\n  #!/usr/bin/env python\n  import pandas as pd\n  import numpy as np\n  import requests\n  import matplotlib.pyplot as plt\n  import matplotlib.dates as mdates\n  import matplotlib.colors as mcolors\n  from matplotlib.dates import DateFormatter\n  from matplotlib import cm\n  from mpl_toolkits.basemap import Basemap\n  \n  # Step 1: ODB MHW API (OpenAPI) Fetch according to its OpenAPI Specification (OAS)\n  # Find API server at OAS: https://api.odb.ntu.edu.tw/hub/swagger?node=odb_mhw_v1\n  def fetch_mhw_data(lon0, lat0, lon1, lat1, start, end):\n      url = f\"https://eco.odb.ntu.edu.tw/api/mhw\"\n      params = {\n          \"lon0\": lon0,\n          \"lat0\": lat0,\n          \"lon1\": lon1,\n          \"lat1\": lat1,\n          \"start\": start,\n          \"end\": end,\n          \"append\": \"sst,sst_anomaly,level\",\n      }\n      response = requests.get(url, params=params)  # Send request to API server and get JSON response from the server\n      if response.status_code == 200:\n          return pd.DataFrame(response.json())  # Convert JSON response to Pandas dataframe\n      else:\n          print(\"Failed to fetch data:\", response.text)\n          return None\n  \n  # When fetching ODB MHW data variables sst (SST), sst_anomaly (SST anomalies), and level (MHW levels), you got API response like:\n  '''\n  [\n    {\n    \"lon\": 135.125,       # longitude \n    \"lat\": 15.125,        # latitude\n    \"date\": \"2024-12-01\", # temporal (date) field\n    \"level\": 1,           # data fields including 'level', 'sst', 'sst_anomaly' which defined by the `append` parameter\n    \"sst\": 29.0103206634522,\n    \"sst_anomaly\": 0.9724\n    }, \n  ]\n  '''\n\n  # Niño 3.4 區域範圍\n  # region for Niño 3.4 (5°N–5°S, 170°W–120°W)\n  lon0, lon1 = -170, -120  \n  lat0, lat1 = -5, 5\n  start, end = \"2025-05-01\", \"2025-05-30\"\n  data = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\n  print(data.head())\n  \n  # Test a stronger La Niña event\n  # Plot a wider region, but it across 180°E antimeridian, so we need to split the data fetching \n  start, end = \"2007-12-01\", \"2007-12-30\"\n  lat0, lat1 = -25, 25\n  lon0, lon1 = 135, -60  # 180°E to 300°E\n  \n  # def get_combined_ssta_data():\n  d1 = fetch_mhw_data(-179.999, lat0, lon1, lat1, start, end)\n  d2 = fetch_mhw_data(lon0, lat0, 179.999, lat1, start, end)\n  # return \n  data = pd.concat([d1, d2], ignore_index=True)\n  print(data.head())\n  \n  data[\"date\"] = pd.to_datetime(data[\"date\"])\n  data['lon_360'] = data['lon'].apply(lambda x: x + 360 if x < 0 else x) # basemap needs 0-360 degrees longitude\n  \n  # Reshape to grid for plotting (matrix-like dataframe: column is longitude, row is latitude, just like the grids in our result plot)\n  def reshape_to_grid_fixed(data, column, date, lon_col='lon'):\n      data_filtered = data[data[\"date\"] == date]\n      all_lats = np.sort(data[\"lat\"].unique())\n      all_lons = np.sort(data[lon_col].unique())\n      grid = pd.DataFrame(index=all_lats, columns=all_lons)\n      for _, row in data_filtered.iterrows():\n          grid.at[row[\"lat\"], row[lon_col]] = row[column]\n      return grid.astype(float)\n  \n  grid = reshape_to_grid_fixed(data, 'sst_anomaly', start, lon_col='lon_360') # package Basemap accept 0-360 degree, so we need to convert it\n  print(grid.tail())\n  \n  def draw_nino_regions(m):\n      \"\"\"畫出 Niño 區域在 basemap 上\"\"\"\n      boxes = {\n          'Niño 1+2': (270, 280, -10, 0),    # 90W~80W\n          'Niño 3':   (210, 270, -5, 5),     # 150W~90W\n          'Niño 4':   (160, 210, -5, 5),     # 160E~150W\n          'Niño 3.4': (190, 240, -5, 5),     # 170W~120W\n      }\n      colors = {\n          'Niño 1+2': 'deepskyblue',\n          'Niño 3':   'darkorange',\n          'Niño 4':   'limegreen',\n          'Niño 3.4': 'crimson',\n      }\n      linestyles = {\n          'Niño 1+2': 'dashed',\n          'Niño 3':   'dashed',\n          'Niño 4':   'dashed',\n          'Niño 3.4': 'dashdot',\n      }\n  \n      for name, (lon_min, lon_max, lat_min, lat_max) in boxes.items():\n          x = [lon_min, lon_max, lon_max, lon_min, lon_min]\n          y = [lat_min, lat_min, lat_max, lat_max, lat_min]\n          m.plot(x, y, latlon=True, linestyle=linestyles[name],\n                 linewidth=1.5, label=name, color=colors[name])\n      plt.legend(loc='lower center', bbox_to_anchor=(0.5, -0.25), ncol=4, fontsize='small')\n  \n  # 畫出海表溫距平值分佈地圖 distribution map at specific month, year of SST anomalies by ODB MHW API\n  def plot_ssta_grid(grid, date, lon0, lon1, lat0, lat1):\n      plt.figure(figsize=(12, 5))\n      fig, ax = plt.subplots(figsize=(12, 4))\n      m = Basemap(projection=\"cyl\", llcrnrlon=lon0, urcrnrlon=lon1,\n                  llcrnrlat=lat0, urcrnrlat=lat1, resolution=\"l\", ax=ax)\n      m.drawcoastlines()\n      m.drawparallels(np.arange(lat0, lat1+1, 5), labels=[1,0,0,0])\n      m.drawmeridians(np.arange(lon0, lon1+1, 10), labels=[0,0,0,1])\n      m.drawmapboundary(fill_color='white')\n  \n      # 經緯度格點\n      lon2d, lat2d = np.meshgrid(grid.columns.astype(float), grid.index.astype(float))\n  \n      # 繪製底圖 We need fill each grid with colors by SST anomaly values in the `grid` dataframe\n      cs = m.contourf(lon2d, lat2d, grid.values.astype(float), cmap=cm.RdYlBu_r,\n                      levels=np.linspace(-3, 3, 21), extend='both', latlon=True)\n  \n      draw_nino_regions(m)\n  \n      cbar = plt.colorbar(cs, orientation=\"vertical\", shrink=0.8, pad=0.02)\n      cbar.set_label(\"SST Anomaly (°C)\")\n      plt.title(f\"SST Anomalies in Central Pacific (Nino3.4) - {date.strftime('%b %Y')}\")\n      plt.tight_layout()\n      plt.show()\n  \n  plot_ssta_grid(grid, pd.to_datetime(start), lon0, lon1+360, lat0, lat1)\n  \n  # Function to get Niño 3.4 SST anomalies from NOAA data\n  # Following https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php\n  # The Oceanic Niño Index (ONI): running 3-month mean SST anomaly for the Niño 3.4 region (5oN-5oS, 120o-170oW)\n  # El Niño/La Niña event: 5 consecutive overlapping 3-month periods >/< +- 0.5oC\n  def get_nino34_anomalies(start=\"1950\", end=\"2025\"):\n      url = \"https://psl.noaa.gov/data/timeseries/month/data/nino34.long.anom.data\"\n      response = requests.get(url, timeout=30)\n      lines = response.text.strip().split('\\n')[1:]  # skip header\n  \n      data = []\n      for line in lines:\n          parts = line.strip().split()\n          if len(parts) < 13:\n              continue\n          try:\n              year = int(parts[0])\n              if year < int(start[:4]) or year > int(end[:4]):\n                  continue\n              for i, val in enumerate(parts[1:13]):\n                  if '-99.99' in val:\n                      break\n                  ts = pd.Timestamp(year=year, month=i + 1, day=15)\n                  data.append((ts, float(val)))\n          except ValueError:\n              continue\n  \n      return pd.DataFrame(data, columns=[\"date\", \"ssta\"]).set_index(\"date\")\n  \n  \n  ssta = get_nino34_anomalies(\"1950\", \"2025\")\n  print(ssta.head())\n  \n  # Fetch ODB MHW API data year by year for the specified region\n  def fetch_yearly_data(lon0, lat0, lon1, lat1, start_year, end_year):\n      all_data = []\n      for year in range(start_year, end_year + 1):\n          start = f\"{year}-01-01\"\n          end = f\"{year}-12-31\"\n          print(f\"Fetching data for {start} to {end}...\")\n          yearly_data = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\n          if yearly_data is not None:\n              all_data.append(yearly_data)\n      if all_data:\n          return pd.concat(all_data, ignore_index=True)\n      else:\n          return None\n\n  # ODB MHW API 資料最小時間為1982-01-01，再往前沒有資料\n  # Minimum date for ODB MHW API: 1982-01-01\n  start_year, end_year = 1982, 2024  # Iterate year range to get MHW data\n  ylon0, ylat0, ylon1, ylat1 = -170, -5, -120, 5  # Niño 3.4 region\n  ydata = fetch_yearly_data(ylon0, ylat0, ylon1, ylat1, start_year, end_year)\n\n  nino_mean = ydata.groupby(\"date\")[\"sst_anomaly\"].mean()\n  nino_mean.index = pd.to_datetime(nino_mean.index)\n  print(nino_mean.head())\n  print(len(nino_mean))\n  \n  sst_mean = ydata.groupby(\"date\")[\"sst\"].mean()\n  sst_mean.index = pd.to_datetime(sst_mean.index)\n  print(sst_mean.head())\n  print(len(sst_mean))\n\n  fig, axes = plt.subplots(2, 1, figsize=(14, 7), sharex=True)\n  \n  # Plot 1: Niño 3.4 SST anomaly\n  axes[0].plot(ssta.index, ssta, color='cornflowerblue', lw=1)\n  axes[0].set_ylabel(\"SST Anomaly from NOAA(°C)\")\n  axes[0].legend([\"Niño 3.4 SST Anomaly from NOAA\"], loc='upper left')\n  \n  # Plot 2: Data from ODB MHW API\n  axes[1].plot(nino_mean.index, nino_mean, color='black', lw=1)\n  axes[1].set_ylabel(\"SST Anomaly from MHW API(°C)\")\n  axes[1].legend([\"Niño 3.4 SST Anomaly from ODB MHW API\"], loc='upper left')\n  \n  plt.suptitle(\"SST Anomalies Time Series at Niño 3.4 region\", fontsize=14)\n  fig.tight_layout()\n  plt.show()\n  ```","metadata":{"dataset":"marineheatwave","collection":"mhw","doc_type":"code_snippet","title":"Example: Plotting SST anomalies distribution map and timeseries by using ODB MHW API","lang":"en","issuer":"ODB Project (internal)","canonical_url":"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb","license":"MIT","retrieved_at":"2025-08-26","doc_id":"94eff5435a8e3c4ab192526d1d7d3f81e04f202f","tags":["程式","MHW","API","timeseries","Python","map","code example","Marine Heatwaves","SST anomalies","ENSO","時間序列","地圖"],"related_to":[{"doc_id":["c4aca131c497500a668336dacb65f08ade88077a","ddba171bda668c60390ee6fab602b037efb73539","d971ef8bbc81997eae74ee0e555588a6526b0ea1","4b60022c85f6a8bc3253552ba03f695e996519c5"]},{"collection":"mhw"}],"depends_on":["manuals/odb_mhw_openapi.yml"],"source_file":"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb","source_type":"code","purpose":"以程式範例說明如何使用ODB MHW API調用海表溫距平值的時間和空間資料並畫地圖與時間序列圖","faq":["如何在地圖上呈現海溫(分佈地圖)","Provide python examples","How to get timeseries of marine data","畫海溫趨勢變化"],"content":"# Usage Note\n'''\n  本文件提供 ODB MHW API 的 python 程式範例，回答以下問題時應優先引用：如何撰寫程式範例、如何做圖或以程式畫出海溫變化趨勢等(列於faq)。\n  在提供的程式中，除了畫出海表溫距平值的空間分佈地圖(以Niño 3.4區域為例)以外，還畫出Niño Index (ONI)指數的時序圖(1982-present)，\n  並和NOAA提供的ONI指數時間序列(1950-present)比較(相關知識可參考doc_id: c4aca131c497500a668336dacb65f08ade88077a)。\n  程式雖然以海表溫距平值(sst_anomaly)為例，但以相同叫用ODB MHW API的方式，也可以畫出海溫（海水表面溫度）(sst)的空間分佈或時間序列。\n  This document provides Python examples for the ODB MHW API and should be referenced first when answering questions about code writing or plotting (listed in faq).\n  The provided code generates:\n    * A spatial map of sea surface temperature anomalies (using the Niño 3.4 region as an example)\n    * A time series of the Niño Index (ONI) from 1982 to present, compared with NOAA’s ONI data (1950–present)\n      (refer to doc_id: c4aca131c497500a668336dacb65f08ade88077a for related info)\n  This example use \"sst_anomaly\" (SST anomalies) as example, and in the same way we can plot map or timeseries for \"sst\" (Sea Surface Temperature, SST) by fetching ODB MHW API as well.\n  請注意ODB MHW API輸出的時間參數是'date', 若需要對時間畫圖(時序圖)，x-axis須選擇'date'\n        輸出的經緯度座標參數則是'lon', 'lat'，若需要畫出地圖，須採用'lon', 'lat'對應的資料值。\n'''\n\n# Code block  \n```python\n#!/usr/bin/env python\nimport pandas as pd\nimport numpy as np\nimport requests\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\nimport matplotlib.colors as mcolors\nfrom matplotlib.dates import DateFormatter\nfrom matplotlib import cm\nfrom mpl_toolkits.basemap import Basemap\n\n# Step 1: ODB MHW API (OpenAPI) Fetch according to its OpenAPI Specification (OAS)\n# Find API server at OAS: https://api.odb.ntu.edu.tw/hub/swagger?node=odb_mhw_v1\ndef fetch_mhw_data(lon0, lat0, lon1, lat1, start, end):\n    url = f\"https://eco.odb.ntu.edu.tw/api/mhw\"\n    params = {\n        \"lon0\": lon0,\n        \"lat0\": lat0,\n        \"lon1\": lon1,\n        \"lat1\": lat1,\n        \"start\": start,\n        \"end\": end,\n        \"append\": \"sst,sst_anomaly,level\",\n    }\n    response = requests.get(url, params=params)  # Send request to API server and get JSON response from the server\n    if response.status_code == 200:\n        return pd.DataFrame(response.json())  # Convert JSON response to Pandas dataframe\n    else:\n        print(\"Failed to fetch data:\", response.text)\n        return None\n\n# When fetching ODB MHW data variables sst (SST), sst_anomaly (SST anomalies), and level (MHW levels), you got API response like:\n'''\n[\n  {\n  \"lon\": 135.125,       # longitude \n  \"lat\": 15.125,        # latitude\n  \"date\": \"2024-12-01\", # temporal (date) field\n  \"level\": 1,           # data fields including 'level', 'sst', 'sst_anomaly' which defined by the `append` parameter\n  \"sst\": 29.0103206634522,\n  \"sst_anomaly\": 0.9724\n  }, \n]\n'''\n\n# Niño 3.4 區域範圍\n# region for Niño 3.4 (5°N–5°S, 170°W–120°W)\nlon0, lon1 = -170, -120  \nlat0, lat1 = -5, 5\nstart, end = \"2025-05-01\", \"2025-05-30\"\ndata = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\nprint(data.head())\n\n# Test a stronger La Niña event\n# Plot a wider region, but it across 180°E antimeridian, so we need to split the data fetching \nstart, end = \"2007-12-01\", \"2007-12-30\"\nlat0, lat1 = -25, 25\nlon0, lon1 = 135, -60  # 180°E to 300°E\n\n# def get_combined_ssta_data():\nd1 = fetch_mhw_data(-179.999, lat0, lon1, lat1, start, end)\nd2 = fetch_mhw_data(lon0, lat0, 179.999, lat1, start, end)\n# return \ndata = pd.concat([d1, d2], ignore_index=True)\nprint(data.head())\n\ndata[\"date\"] = pd.to_datetime(data[\"date\"])\ndata['lon_360'] = data['lon'].apply(lambda x: x + 360 if x < 0 else x) # basemap needs 0-360 degrees longitude\n\n# Reshape to grid for plotting (matrix-like dataframe: column is longitude, row is latitude, just like the grids in our result plot)\ndef reshape_to_grid_fixed(data, column, date, lon_col='lon'):\n    data_filtered = data[data[\"date\"] == date]\n    all_lats = np.sort(data[\"lat\"].unique())\n    all_lons = np.sort(data[lon_col].unique())\n    grid = pd.DataFrame(index=all_lats, columns=all_lons)\n    for _, row in data_filtered.iterrows():\n        grid.at[row[\"lat\"], row[lon_col]] = row[column]\n    return grid.astype(float)\n\ngrid = reshape_to_grid_fixed(data, 'sst_anomaly', start, lon_col='lon_360') # package Basemap accept 0-360 degree, so we need to convert it\nprint(grid.tail())\n\ndef draw_nino_regions(m):\n    \"\"\"畫出 Niño 區域在 basemap 上\"\"\"\n    boxes = {\n        'Niño 1+2': (270, 280, -10, 0),    # 90W~80W\n        'Niño 3':   (210, 270, -5, 5),     # 150W~90W\n        'Niño 4':   (160, 210, -5, 5),     # 160E~150W\n        'Niño 3.4': (190, 240, -5, 5),     # 170W~120W\n    }\n    colors = {\n        'Niño 1+2': 'deepskyblue',\n        'Niño 3':   'darkorange',\n        'Niño 4':   'limegreen',\n        'Niño 3.4': 'crimson',\n    }\n    linestyles = {\n        'Niño 1+2': 'dashed',\n        'Niño 3':   'dashed',\n        'Niño 4':   'dashed',\n        'Niño 3.4': 'dashdot',\n    }\n\n    for name, (lon_min, lon_max, lat_min, lat_max) in boxes.items():\n        x = [lon_min, lon_max, lon_max, lon_min, lon_min]\n        y = [lat_min, lat_min, lat_max, lat_max, lat_min]\n        m.plot(x, y, latlon=True, linestyle=linestyles[name],\n               linewidth=1.5, label=name, color=colors[name])\n    plt.legend(loc='lower center', bbox_to_anchor=(0.5, -0.25), ncol=4, fontsize='small')\n\n# 畫出海表溫距平值分佈地圖 distribution map at specific month, year of SST anomalies by ODB MHW API\ndef plot_ssta_grid(grid, date, lon0, lon1, lat0, lat1):\n    plt.figure(figsize=(12, 5))\n    fig, ax = plt.subplots(figsize=(12, 4))\n    m = Basemap(projection=\"cyl\", llcrnrlon=lon0, urcrnrlon=lon1,\n                llcrnrlat=lat0, urcrnrlat=lat1, resolution=\"l\", ax=ax)\n    m.drawcoastlines()\n    m.drawparallels(np.arange(lat0, lat1+1, 5), labels=[1,0,0,0])\n    m.drawmeridians(np.arange(lon0, lon1+1, 10), labels=[0,0,0,1])\n    m.drawmapboundary(fill_color='white')\n\n    # 經緯度格點\n    lon2d, lat2d = np.meshgrid(grid.columns.astype(float), grid.index.astype(float))\n\n    # 繪製底圖 We need fill each grid with colors by SST anomaly values in the `grid` dataframe\n    cs = m.contourf(lon2d, lat2d, grid.values.astype(float), cmap=cm.RdYlBu_r,\n                    levels=np.linspace(-3, 3, 21), extend='both', latlon=True)\n\n    draw_nino_regions(m)\n\n    cbar = plt.colorbar(cs, orientation=\"vertical\", shrink=0.8, pad=0.02)\n    cbar.set_label(\"SST Anomaly (°C)\")\n    plt.title(f\"SST Anomalies in Central Pacific (Nino3.4) - {date.strftime('%b %Y')}\")\n    plt.tight_layout()\n    plt.show()\n\nplot_ssta_grid(grid, pd.to_datetime(start), lon0, lon1+360, lat0, lat1)\n\n# Function to get Niño 3.4 SST anomalies from NOAA data\n# Following https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php\n# The Oceanic Niño Index (ONI): running 3-month mean SST anomaly for the Niño 3.4 region (5oN-5oS, 120o-170oW)\n# El Niño/La Niña event: 5 consecutive overlapping 3-month periods >/< +- 0.5oC\ndef get_nino34_anomalies(start=\"1950\", end=\"2025\"):\n    url = \"https://psl.noaa.gov/data/timeseries/month/data/nino34.long.anom.data\"\n    response = requests.get(url, timeout=30)\n    lines = response.text.strip().split('\\n')[1:]  # skip header\n\n    data = []\n    for line in lines:\n        parts = line.strip().split()\n        if len(parts) < 13:\n            continue\n        try:\n            year = int(parts[0])\n            if year < int(start[:4]) or year > int(end[:4]):\n                continue\n            for i, val in enumerate(parts[1:13]):\n                if '-99.99' in val:\n                    break\n                ts = pd.Timestamp(year=year, month=i + 1, day=15)\n                data.append((ts, float(val)))\n        except ValueError:\n            continue\n\n    return pd.DataFrame(data, columns=[\"date\", \"ssta\"]).set_index(\"date\")\n\n\nssta = get_nino34_anomalies(\"1950\", \"2025\")\nprint(ssta.head())\n\n# Fetch ODB MHW API data year by year for the specified region\ndef fetch_yearly_data(lon0, lat0, lon1, lat1, start_year, end_year):\n    all_data = []\n    for year in range(start_year, end_year + 1):\n        start = f\"{year}-01-01\"\n        end = f\"{year}-12-31\"\n        print(f\"Fetching data for {start} to {end}...\")\n        yearly_data = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\n        if yearly_data is not None:\n            all_data.append(yearly_data)\n    if all_data:\n        return pd.concat(all_data, ignore_index=True)\n    else:\n        return None\n\n# ODB MHW API 資料最小時間為1982-01-01，再往前沒有資料\n# Minimum date for ODB MHW API: 1982-01-01\nstart_year, end_year = 1982, 2024  # Iterate year range to get MHW data\nylon0, ylat0, ylon1, ylat1 = -170, -5, -120, 5  # Niño 3.4 region\nydata = fetch_yearly_data(ylon0, ylat0, ylon1, ylat1, start_year, end_year)\n\nnino_mean = ydata.groupby(\"date\")[\"sst_anomaly\"].mean()\nnino_mean.index = pd.to_datetime(nino_mean.index)\nprint(nino_mean.head())\nprint(len(nino_mean))\n\nsst_mean = ydata.groupby(\"date\")[\"sst\"].mean()\nsst_mean.index = pd.to_datetime(sst_mean.index)\nprint(sst_mean.head())\nprint(len(sst_mean))\n\nfig, axes = plt.subplots(2, 1, figsize=(14, 7), sharex=True)\n\n# Plot 1: Niño 3.4 SST anomaly\naxes[0].plot(ssta.index, ssta, color='cornflowerblue', lw=1)\naxes[0].set_ylabel(\"SST Anomaly from NOAA(°C)\")\naxes[0].legend([\"Niño 3.4 SST Anomaly from NOAA\"], loc='upper left')\n\n# Plot 2: Data from ODB MHW API\naxes[1].plot(nino_mean.index, nino_mean, color='black', lw=1)\naxes[1].set_ylabel(\"SST Anomaly from MHW API(°C)\")\naxes[1].legend([\"Niño 3.4 SST Anomaly from ODB MHW API\"], loc='upper left')\n\nplt.suptitle(\"SST Anomalies Time Series at Niño 3.4 region\", fontsize=14)\nfig.tight_layout()\nplt.show()\n```"}}],"artifacts":[{"id":"text_a9ea13f349b275cd4b23455f01ef7ce360e945dd","source_file":"bak/temp_uploads/legacy/mhw_plot_sst_anomalies_distribution_map_example.yml","artifact_type":"text_chunk","metadata":{"dataset":"marineheatwave","collection":"mhw","doc_type":"code_snippet","title":"Example: Plotting SST anomalies distribution map and timeseries by using ODB MHW API","lang":"en","issuer":"ODB Project (internal)","canonical_url":"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb","license":"MIT","retrieved_at":"2025-08-26","doc_id":"94eff5435a8e3c4ab192526d1d7d3f81e04f202f","tags":["程式","MHW","API","timeseries","Python","map","code example","Marine Heatwaves","SST anomalies","ENSO","時間序列","地圖"],"related_to":[{"doc_id":["c4aca131c497500a668336dacb65f08ade88077a","ddba171bda668c60390ee6fab602b037efb73539","d971ef8bbc81997eae74ee0e555588a6526b0ea1","4b60022c85f6a8bc3253552ba03f695e996519c5"]},{"collection":"mhw"}],"depends_on":["manuals/odb_mhw_openapi.yml"],"source_file":"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb","source_type":"code","purpose":"以程式範例說明如何使用ODB MHW API調用海表溫距平值的時間和空間資料並畫地圖與時間序列圖","faq":["如何在地圖上呈現海溫(分佈地圖)","Provide python examples","How to get timeseries of marine data","畫海溫趨勢變化"],"content":"# Usage Note\n'''\n  本文件提供 ODB MHW API 的 python 程式範例，回答以下問題時應優先引用：如何撰寫程式範例、如何做圖或以程式畫出海溫變化趨勢等(列於faq)。\n  在提供的程式中，除了畫出海表溫距平值的空間分佈地圖(以Niño 3.4區域為例)以外，還畫出Niño Index (ONI)指數的時序圖(1982-present)，\n  並和NOAA提供的ONI指數時間序列(1950-present)比較(相關知識可參考doc_id: c4aca131c497500a668336dacb65f08ade88077a)。\n  程式雖然以海表溫距平值(sst_anomaly)為例，但以相同叫用ODB MHW API的方式，也可以畫出海溫（海水表面溫度）(sst)的空間分佈或時間序列。\n  This document provides Python examples for the ODB MHW API and should be referenced first when answering questions about code writing or plotting (listed in faq).\n  The provided code generates:\n    * A spatial map of sea surface temperature anomalies (using the Niño 3.4 region as an example)\n    * A time series of the Niño Index (ONI) from 1982 to present, compared with NOAA’s ONI data (1950–present)\n      (refer to doc_id: c4aca131c497500a668336dacb65f08ade88077a for related info)\n  This example use \"sst_anomaly\" (SST anomalies) as example, and in the same way we can plot map or timeseries for \"sst\" (Sea Surface Temperature, SST) by fetching ODB MHW API as well.\n  請注意ODB MHW API輸出的時間參數是'date', 若需要對時間畫圖(時序圖)，x-axis須選擇'date'\n        輸出的經緯度座標參數則是'lon', 'lat'，若需要畫出地圖，須採用'lon', 'lat'對應的資料值。\n'''\n\n# Code block  \n```python\n#!/usr/bin/env python\nimport pandas as pd\nimport numpy as np\nimport requests\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\nimport matplotlib.colors as mcolors\nfrom matplotlib.dates import DateFormatter\nfrom matplotlib import cm\nfrom mpl_toolkits.basemap import Basemap\n\n# Step 1: ODB MHW API (OpenAPI) Fetch according to its OpenAPI Specification (OAS)\n# Find API server at OAS: https://api.odb.ntu.edu.tw/hub/swagger?node=odb_mhw_v1\ndef fetch_mhw_data(lon0, lat0, lon1, lat1, start, end):\n    url = f\"https://eco.odb.ntu.edu.tw/api/mhw\"\n    params = {\n        \"lon0\": lon0,\n        \"lat0\": lat0,\n        \"lon1\": lon1,\n        \"lat1\": lat1,\n        \"start\": start,\n        \"end\": end,\n        \"append\": \"sst,sst_anomaly,level\",\n    }\n    response = requests.get(url, params=params)  # Send request to API server and get JSON response from the server\n    if response.status_code == 200:\n        return pd.DataFrame(response.json())  # Convert JSON response to Pandas dataframe\n    else:\n        print(\"Failed to fetch data:\", response.text)\n        return None\n\n# When fetching ODB MHW data variables sst (SST), sst_anomaly (SST anomalies), and level (MHW levels), you got API response like:\n'''\n[\n  {\n  \"lon\": 135.125,       # longitude \n  \"lat\": 15.125,        # latitude\n  \"date\": \"2024-12-01\", # temporal (date) field\n  \"level\": 1,           # data fields including 'level', 'sst', 'sst_anomaly' which defined by the `append` parameter\n  \"sst\": 29.0103206634522,\n  \"sst_anomaly\": 0.9724\n  }, \n]\n'''\n\n# Niño 3.4 區域範圍\n# region for Niño 3.4 (5°N–5°S, 170°W–120°W)\nlon0, lon1 = -170, -120  \nlat0, lat1 = -5, 5\nstart, end = \"2025-05-01\", \"2025-05-30\"\ndata = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\nprint(data.head())\n\n# Test a stronger La Niña event\n# Plot a wider region, but it across 180°E antimeridian, so we need to split the data fetching \nstart, end = \"2007-12-01\", \"2007-12-30\"\nlat0, lat1 = -25, 25\nlon0, lon1 = 135, -60  # 180°E to 300°E\n\n# def get_combined_ssta_data():\nd1 = fetch_mhw_data(-179.999, lat0, lon1, lat1, start, end)\nd2 = fetch_mhw_data(lon0, lat0, 179.999, lat1, start, end)\n# return \ndata = pd.concat([d1, d2], ignore_index=True)\nprint(data.head())\n\ndata[\"date\"] = pd.to_datetime(data[\"date\"])\ndata['lon_360'] = data['lon'].apply(lambda x: x + 360 if x < 0 else x) # basemap needs 0-360 degrees longitude\n\n# Reshape to grid for plotting (matrix-like dataframe: column is longitude, row is latitude, just like the grids in our result plot)\ndef reshape_to_grid_fixed(data, column, date, lon_col='lon'):\n    data_filtered = data[data[\"date\"] == date]\n    all_lats = np.sort(data[\"lat\"].unique())\n    all_lons = np.sort(data[lon_col].unique())\n    grid = pd.DataFrame(index=all_lats, columns=all_lons)\n    for _, row in data_filtered.iterrows():\n        grid.at[row[\"lat\"], row[lon_col]] = row[column]\n    return grid.astype(float)\n\ngrid = reshape_to_grid_fixed(data, 'sst_anomaly', start, lon_col='lon_360') # package Basemap accept 0-360 degree, so we need to convert it\nprint(grid.tail())\n\ndef draw_nino_regions(m):\n    \"\"\"畫出 Niño 區域在 basemap 上\"\"\"\n    boxes = {\n        'Niño 1+2': (270, 280, -10, 0),    # 90W~80W\n        'Niño 3':   (210, 270, -5, 5),     # 150W~90W\n        'Niño 4':   (160, 210, -5, 5),     # 160E~150W\n        'Niño 3.4': (190, 240, -5, 5),     # 170W~120W\n    }\n    colors = {\n        'Niño 1+2': 'deepskyblue',\n        'Niño 3':   'darkorange',\n        'Niño 4':   'limegreen',\n        'Niño 3.4': 'crimson',\n    }\n    linestyles = {\n        'Niño 1+2': 'dashed',\n        'Niño 3':   'dashed',\n        'Niño 4':   'dashed',\n        'Niño 3.4': 'dashdot',\n    }\n\n    for name, (lon_min, lon_max, lat_min, lat_max) in boxes.items():\n        x = [lon_min, lon_max, lon_max, lon_min, lon_min]\n        y = [lat_min, lat_min, lat_max, lat_max, lat_min]\n        m.plot(x, y, latlon=True, linestyle=linestyles[name],\n               linewidth=1.5, label=name, color=colors[name])\n    plt.legend(loc='lower center', bbox_to_anchor=(0.5, -0.25), ncol=4, fontsize='small')\n\n# 畫出海表溫距平值分佈地圖 distribution map at specific month, year of SST anomalies by ODB MHW API\ndef plot_ssta_grid(grid, date, lon0, lon1, lat0, lat1):\n    plt.figure(figsize=(12, 5))\n    fig, ax = plt.subplots(figsize=(12, 4))\n    m = Basemap(projection=\"cyl\", llcrnrlon=lon0, urcrnrlon=lon1,\n                llcrnrlat=lat0, urcrnrlat=lat1, resolution=\"l\", ax=ax)\n    m.drawcoastlines()\n    m.drawparallels(np.arange(lat0, lat1+1, 5), labels=[1,0,0,0])\n    m.drawmeridians(np.arange(lon0, lon1+1, 10), labels=[0,0,0,1])\n    m.drawmapboundary(fill_color='white')\n\n    # 經緯度格點\n    lon2d, lat2d = np.meshgrid(grid.columns.astype(float), grid.index.astype(float))\n\n    # 繪製底圖 We need fill each grid with colors by SST anomaly values in the `grid` dataframe\n    cs = m.contourf(lon2d, lat2d, grid.values.astype(float), cmap=cm.RdYlBu_r,\n                    levels=np.linspace(-3, 3, 21), extend='both', latlon=True)\n\n    draw_nino_regions(m)\n\n    cbar = plt.colorbar(cs, orientation=\"vertical\", shrink=0.8, pad=0.02)\n    cbar.set_label(\"SST Anomaly (°C)\")\n    plt.title(f\"SST Anomalies in Central Pacific (Nino3.4) - {date.strftime('%b %Y')}\")\n    plt.tight_layout()\n    plt.show()\n\nplot_ssta_grid(grid, pd.to_datetime(start), lon0, lon1+360, lat0, lat1)\n\n# Function to get Niño 3.4 SST anomalies from NOAA data\n# Following https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php\n# The Oceanic Niño Index (ONI): running 3-month mean SST anomaly for the Niño 3.4 region (5oN-5oS, 120o-170oW)\n# El Niño/La Niña event: 5 consecutive overlapping 3-month periods >/< +- 0.5oC\ndef get_nino34_anomalies(start=\"1950\", end=\"2025\"):\n    url = \"https://psl.noaa.gov/data/timeseries/month/data/nino34.long.anom.data\"\n    response = requests.get(url, timeout=30)\n    lines = response.text.strip().split('\\n')[1:]  # skip header\n\n    data = []\n    for line in lines:\n        parts = line.strip().split()\n        if len(parts) < 13:\n            continue\n        try:\n            year = int(parts[0])\n            if year < int(start[:4]) or year > int(end[:4]):\n                continue\n            for i, val in enumerate(parts[1:13]):\n                if '-99.99' in val:\n                    break\n                ts = pd.Timestamp(year=year, month=i + 1, day=15)\n                data.append((ts, float(val)))\n        except ValueError:\n            continue\n\n    return pd.DataFrame(data, columns=[\"date\", \"ssta\"]).set_index(\"date\")\n\n\nssta = get_nino34_anomalies(\"1950\", \"2025\")\nprint(ssta.head())\n\n# Fetch ODB MHW API data year by year for the specified region\ndef fetch_yearly_data(lon0, lat0, lon1, lat1, start_year, end_year):\n    all_data = []\n    for year in range(start_year, end_year + 1):\n        start = f\"{year}-01-01\"\n        end = f\"{year}-12-31\"\n        print(f\"Fetching data for {start} to {end}...\")\n        yearly_data = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\n        if yearly_data is not None:\n            all_data.append(yearly_data)\n    if all_data:\n        return pd.concat(all_data, ignore_index=True)\n    else:\n        return None\n\n# ODB MHW API 資料最小時間為1982-01-01，再往前沒有資料\n# Minimum date for ODB MHW API: 1982-01-01\nstart_year, end_year = 1982, 2024  # Iterate year range to get MHW data\nylon0, ylat0, ylon1, ylat1 = -170, -5, -120, 5  # Niño 3.4 region\nydata = fetch_yearly_data(ylon0, ylat0, ylon1, ylat1, start_year, end_year)\n\nnino_mean = ydata.groupby(\"date\")[\"sst_anomaly\"].mean()\nnino_mean.index = pd.to_datetime(nino_mean.index)\nprint(nino_mean.head())\nprint(len(nino_mean))\n\nsst_mean = ydata.groupby(\"date\")[\"sst\"].mean()\nsst_mean.index = pd.to_datetime(sst_mean.index)\nprint(sst_mean.head())\nprint(len(sst_mean))\n\nfig, axes = plt.subplots(2, 1, figsize=(14, 7), sharex=True)\n\n# Plot 1: Niño 3.4 SST anomaly\naxes[0].plot(ssta.index, ssta, color='cornflowerblue', lw=1)\naxes[0].set_ylabel(\"SST Anomaly from NOAA(°C)\")\naxes[0].legend([\"Niño 3.4 SST Anomaly from NOAA\"], loc='upper left')\n\n# Plot 2: Data from ODB MHW API\naxes[1].plot(nino_mean.index, nino_mean, color='black', lw=1)\naxes[1].set_ylabel(\"SST Anomaly from MHW API(°C)\")\naxes[1].legend([\"Niño 3.4 SST Anomaly from ODB MHW API\"], loc='upper left')\n\nplt.suptitle(\"SST Anomalies Time Series at Niño 3.4 region\", fontsize=14)\nfig.tight_layout()\nplt.show()\n```","dataset_name":"marineheatwave"},"links":[],"tags":["程式","MHW","API","timeseries","Python","map","code example","Marine Heatwaves","SST anomalies","ENSO","時間序列","地圖"],"page_number":1,"chunk_index":0,"content_type":"metadata","text":"dataset: marineheatwave\ncollection: mhw\ndoc_type: code_snippet\ntitle: \"Example: Plotting SST anomalies distribution map and timeseries by using ODB MHW API\"\nlang: en\nissuer: \"ODB Project (internal)\"\ncanonical_url: \"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb\"\nlicense: \"MIT\"\nretrieved_at: \"2025-08-26\"\ndoc_id: \"94eff5435a8e3c4ab192526d1d7d3f81e04f202f\"\ntags: [程式, MHW, API, timeseries, Python, map, \"code example\", \"Marine Heatwaves\", \"SST anomalies\", ENSO, \"時間序列\", \"地圖\"]\nrelated_to:\n  - doc_id: [\"c4aca131c497500a668336dacb65f08ade88077a\", \"ddba171bda668c60390ee6fab602b037efb73539\", \"d971ef8bbc81997eae74ee0e555588a6526b0ea1\", \"4b60022c85f6a8bc3253552ba03f695e996519c5\"]\n  - collection: \"mhw\"\ndepends_on:\n  - manuals/odb_mhw_openapi.yml\nsource_file: \"https://github.com/ODBapp/2025_NODASS_workshop/blob/main/src/timeseries/timeseries01.ipynb\"\nsource_type: code\npurpose: \"以程式範例說明如何使用ODB MHW API調用海表溫距平值的時間和空間資料並畫地圖與時間序列圖\"\nfaq: [\"如何在地圖上呈現海溫(分佈地圖)\", \"Provide python examples\", \"How to get timeseries of marine data\", \"畫海溫趨勢變化\"]\ncontent: |\n  # Usage Note\n  '''\n    本文件提供 ODB MHW API 的 python 程式範例，回答以下問題時應優先引用：如何撰寫程式範例、如何做圖或以程式畫出海溫變化趨勢等(列於faq)。\n    在提供的程式中，除了畫出海表溫距平值的空間分佈地圖(以Niño 3.4區域為例)以外，還畫出Niño Index (ONI)指數的時序圖(1982-present)，\n    並和NOAA提供的ONI指數時間序列(1950-present)比較(相關知識可參考doc_id: c4aca131c497500a668336dacb65f08ade88077a)。\n    程式雖然以海表溫距平值(sst_anomaly)為例，但以相同叫用ODB MHW API的方式，也可以畫出海溫（海水表面溫度）(sst)的空間分佈或時間序列。\n    This document provides Python examples for the ODB MHW API and should be referenced first when answering questions about code writing or plotting (listed in faq).\n    The provided code generates:\n      * A spatial map of sea surface temperature anomalies (using the Niño 3.4 region as an example)\n      * A time series of the Niño Index (ONI) from 1982 to present, compared with NOAA’s ONI data (1950–present)\n        (refer to doc_id: c4aca131c497500a668336dacb65f08ade88077a for related info)\n    This example use \"sst_anomaly\" (SST anomalies) as example, and in the same way we can plot map or timeseries for \"sst\" (Sea Surface Temperature, SST) by fetching ODB MHW API as well.\n    請注意ODB MHW API輸出的時間參數是'date', 若需要對時間畫圖(時序圖)，x-axis須選擇'date'\n          輸出的經緯度座標參數則是'lon', 'lat'，若需要畫出地圖，須採用'lon', 'lat'對應的資料值。\n  '''\n\n  # Code block  \n  ```python\n  #!/usr/bin/env python\n  import pandas as pd\n  import numpy as np\n  import requests\n  import matplotlib.pyplot as plt\n  import matplotlib.dates as mdates\n  import matplotlib.colors as mcolors\n  from matplotlib.dates import DateFormatter\n  from matplotlib import cm\n  from mpl_toolkits.basemap import Basemap\n  \n  # Step 1: ODB MHW API (OpenAPI) Fetch according to its OpenAPI Specification (OAS)\n  # Find API server at OAS: https://api.odb.ntu.edu.tw/hub/swagger?node=odb_mhw_v1\n  def fetch_mhw_data(lon0, lat0, lon1, lat1, start, end):\n      url = f\"https://eco.odb.ntu.edu.tw/api/mhw\"\n      params = {\n          \"lon0\": lon0,\n          \"lat0\": lat0,\n          \"lon1\": lon1,\n          \"lat1\": lat1,\n          \"start\": start,\n          \"end\": end,\n          \"append\": \"sst,sst_anomaly,level\",\n      }\n      response = requests.get(url, params=params)  # Send request to API server and get JSON response from the server\n      if response.status_code == 200:\n          return pd.DataFrame(response.json())  # Convert JSON response to Pandas dataframe\n      else:\n          print(\"Failed to fetch data:\", response.text)\n          return None\n  \n  # When fetching ODB MHW data variables sst (SST), sst_anomaly (SST anomalies), and level (MHW levels), you got API response like:\n  '''\n  [\n    {\n    \"lon\": 135.125,       # longitude \n    \"lat\": 15.125,        # latitude\n    \"date\": \"2024-12-01\", # temporal (date) field\n    \"level\": 1,           # data fields including 'level', 'sst', 'sst_anomaly' which defined by the `append` parameter\n    \"sst\": 29.0103206634522,\n    \"sst_anomaly\": 0.9724\n    }, \n  ]\n  '''\n\n  # Niño 3.4 區域範圍\n  # region for Niño 3.4 (5°N–5°S, 170°W–120°W)\n  lon0, lon1 = -170, -120  \n  lat0, lat1 = -5, 5\n  start, end = \"2025-05-01\", \"2025-05-30\"\n  data = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\n  print(data.head())\n  \n  # Test a stronger La Niña event\n  # Plot a wider region, but it across 180°E antimeridian, so we need to split the data fetching \n  start, end = \"2007-12-01\", \"2007-12-30\"\n  lat0, lat1 = -25, 25\n  lon0, lon1 = 135, -60  # 180°E to 300°E\n  \n  # def get_combined_ssta_data():\n  d1 = fetch_mhw_data(-179.999, lat0, lon1, lat1, start, end)\n  d2 = fetch_mhw_data(lon0, lat0, 179.999, lat1, start, end)\n  # return \n  data = pd.concat([d1, d2], ignore_index=True)\n  print(data.head())\n  \n  data[\"date\"] = pd.to_datetime(data[\"date\"])\n  data['lon_360'] = data['lon'].apply(lambda x: x + 360 if x < 0 else x) # basemap needs 0-360 degrees longitude\n  \n  # Reshape to grid for plotting (matrix-like dataframe: column is longitude, row is latitude, just like the grids in our result plot)\n  def reshape_to_grid_fixed(data, column, date, lon_col='lon'):\n      data_filtered = data[data[\"date\"] == date]\n      all_lats = np.sort(data[\"lat\"].unique())\n      all_lons = np.sort(data[lon_col].unique())\n      grid = pd.DataFrame(index=all_lats, columns=all_lons)\n      for _, row in data_filtered.iterrows():\n          grid.at[row[\"lat\"], row[lon_col]] = row[column]\n      return grid.astype(float)\n  \n  grid = reshape_to_grid_fixed(data, 'sst_anomaly', start, lon_col='lon_360') # package Basemap accept 0-360 degree, so we need to convert it\n  print(grid.tail())\n  \n  def draw_nino_regions(m):\n      \"\"\"畫出 Niño 區域在 basemap 上\"\"\"\n      boxes = {\n          'Niño 1+2': (270, 280, -10, 0),    # 90W~80W\n          'Niño 3':   (210, 270, -5, 5),     # 150W~90W\n          'Niño 4':   (160, 210, -5, 5),     # 160E~150W\n          'Niño 3.4': (190, 240, -5, 5),     # 170W~120W\n      }\n      colors = {\n          'Niño 1+2': 'deepskyblue',\n          'Niño 3':   'darkorange',\n          'Niño 4':   'limegreen',\n          'Niño 3.4': 'crimson',\n      }\n      linestyles = {\n          'Niño 1+2': 'dashed',\n          'Niño 3':   'dashed',\n          'Niño 4':   'dashed',\n          'Niño 3.4': 'dashdot',\n      }\n  \n      for name, (lon_min, lon_max, lat_min, lat_max) in boxes.items():\n          x = [lon_min, lon_max, lon_max, lon_min, lon_min]\n          y = [lat_min, lat_min, lat_max, lat_max, lat_min]\n          m.plot(x, y, latlon=True, linestyle=linestyles[name],\n                 linewidth=1.5, label=name, color=colors[name])\n      plt.legend(loc='lower center', bbox_to_anchor=(0.5, -0.25), ncol=4, fontsize='small')\n  \n  # 畫出海表溫距平值分佈地圖 distribution map at specific month, year of SST anomalies by ODB MHW API\n  def plot_ssta_grid(grid, date, lon0, lon1, lat0, lat1):\n      plt.figure(figsize=(12, 5))\n      fig, ax = plt.subplots(figsize=(12, 4))\n      m = Basemap(projection=\"cyl\", llcrnrlon=lon0, urcrnrlon=lon1,\n                  llcrnrlat=lat0, urcrnrlat=lat1, resolution=\"l\", ax=ax)\n      m.drawcoastlines()\n      m.drawparallels(np.arange(lat0, lat1+1, 5), labels=[1,0,0,0])\n      m.drawmeridians(np.arange(lon0, lon1+1, 10), labels=[0,0,0,1])\n      m.drawmapboundary(fill_color='white')\n  \n      # 經緯度格點\n      lon2d, lat2d = np.meshgrid(grid.columns.astype(float), grid.index.astype(float))\n  \n      # 繪製底圖 We need fill each grid with colors by SST anomaly values in the `grid` dataframe\n      cs = m.contourf(lon2d, lat2d, grid.values.astype(float), cmap=cm.RdYlBu_r,\n                      levels=np.linspace(-3, 3, 21), extend='both', latlon=True)\n  \n      draw_nino_regions(m)\n  \n      cbar = plt.colorbar(cs, orientation=\"vertical\", shrink=0.8, pad=0.02)\n      cbar.set_label(\"SST Anomaly (°C)\")\n      plt.title(f\"SST Anomalies in Central Pacific (Nino3.4) - {date.strftime('%b %Y')}\")\n      plt.tight_layout()\n      plt.show()\n  \n  plot_ssta_grid(grid, pd.to_datetime(start), lon0, lon1+360, lat0, lat1)\n  \n  # Function to get Niño 3.4 SST anomalies from NOAA data\n  # Following https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php\n  # The Oceanic Niño Index (ONI): running 3-month mean SST anomaly for the Niño 3.4 region (5oN-5oS, 120o-170oW)\n  # El Niño/La Niña event: 5 consecutive overlapping 3-month periods >/< +- 0.5oC\n  def get_nino34_anomalies(start=\"1950\", end=\"2025\"):\n      url = \"https://psl.noaa.gov/data/timeseries/month/data/nino34.long.anom.data\"\n      response = requests.get(url, timeout=30)\n      lines = response.text.strip().split('\\n')[1:]  # skip header\n  \n      data = []\n      for line in lines:\n          parts = line.strip().split()\n          if len(parts) < 13:\n              continue\n          try:\n              year = int(parts[0])\n              if year < int(start[:4]) or year > int(end[:4]):\n                  continue\n              for i, val in enumerate(parts[1:13]):\n                  if '-99.99' in val:\n                      break\n                  ts = pd.Timestamp(year=year, month=i + 1, day=15)\n                  data.append((ts, float(val)))\n          except ValueError:\n              continue\n  \n      return pd.DataFrame(data, columns=[\"date\", \"ssta\"]).set_index(\"date\")\n  \n  \n  ssta = get_nino34_anomalies(\"1950\", \"2025\")\n  print(ssta.head())\n  \n  # Fetch ODB MHW API data year by year for the specified region\n  def fetch_yearly_data(lon0, lat0, lon1, lat1, start_year, end_year):\n      all_data = []\n      for year in range(start_year, end_year + 1):\n          start = f\"{year}-01-01\"\n          end = f\"{year}-12-31\"\n          print(f\"Fetching data for {start} to {end}...\")\n          yearly_data = fetch_mhw_data(lon0, lat0, lon1, lat1, start, end)\n          if yearly_data is not None:\n              all_data.append(yearly_data)\n      if all_data:\n          return pd.concat(all_data, ignore_index=True)\n      else:\n          return None\n\n  # ODB MHW API 資料最小時間為1982-01-01，再往前沒有資料\n  # Minimum date for ODB MHW API: 1982-01-01\n  start_year, end_year = 1982, 2024  # Iterate year range to get MHW data\n  ylon0, ylat0, ylon1, ylat1 = -170, -5, -120, 5  # Niño 3.4 region\n  ydata = fetch_yearly_data(ylon0, ylat0, ylon1, ylat1, start_year, end_year)\n\n  nino_mean = ydata.groupby(\"date\")[\"sst_anomaly\"].mean()\n  nino_mean.index = pd.to_datetime(nino_mean.index)\n  print(nino_mean.head())\n  print(len(nino_mean))\n  \n  sst_mean = ydata.groupby(\"date\")[\"sst\"].mean()\n  sst_mean.index = pd.to_datetime(sst_mean.index)\n  print(sst_mean.head())\n  print(len(sst_mean))\n\n  fig, axes = plt.subplots(2, 1, figsize=(14, 7), sharex=True)\n  \n  # Plot 1: Niño 3.4 SST anomaly\n  axes[0].plot(ssta.index, ssta, color='cornflowerblue', lw=1)\n  axes[0].set_ylabel(\"SST Anomaly from NOAA(°C)\")\n  axes[0].legend([\"Niño 3.4 SST Anomaly from NOAA\"], loc='upper left')\n  \n  # Plot 2: Data from ODB MHW API\n  axes[1].plot(nino_mean.index, nino_mean, color='black', lw=1)\n  axes[1].set_ylabel(\"SST Anomaly from MHW API(°C)\")\n  axes[1].legend([\"Niño 3.4 SST Anomaly from ODB MHW API\"], loc='upper left')\n  \n  plt.suptitle(\"SST Anomalies Time Series at Niño 3.4 region\", fontsize=14)\n  fig.tight_layout()\n  plt.show()\n  ```"}]}